<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sheet Viewer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    thead th { position: sticky; top: 0; background: #fff; }
    tbody tr:nth-child(odd) { background: rgba(0,0,0,0.02); }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-7xl mx-auto p-4 sm:p-6">
    <header class="mb-4">
      <h1 class="text-2xl font-bold">Hiển thị dữ liệu Sheet</h1>
      <p class="text-sm text-gray-600">Tìm kiếm tức thì, sắp xếp theo cột, ẩn/hiện cột, và phân trang.</p>
    </header>
    <section class="mb-3 grid grid-cols-1 md:grid-cols-3 gap-3 items-end">
      <label class="block">
        <span class="text-sm font-medium">Link CSV</span>
        <input id="csvUrl" type="url" value="https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeBkoyDAioUb9yjM-qqzXBWldNKU7RqXgwVId4cNY_FD3MWwNcE9KZTVYeOncYYRBhWZ8UgQbxCHZ/pub?gid=481463274&single=true&output=csv"
               class="mt-1 w-full rounded-xl border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
      </label>
      <button id="loadBtn" class="rounded-xl px-4 py-2 border border-indigo-600 text-indigo-700 hover:bg-indigo-50">Tải dữ liệu</button>
      <label class="block">
        <span class="text-sm font-medium">Tìm kiếm</span>
        <input id="searchInput" type="text" placeholder="Gõ để lọc theo từ khóa…"
               class="mt-1 w-full rounded-xl border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
      </label>
    </section>
    <details class="mb-4">
      <summary class="cursor-pointer text-sm text-gray-700">Tùy chọn hiện cột</summary>
      <div id="columnToggles" class="mt-2 flex flex-wrap gap-2"></div>
    </details>
    <div id="tableWrap" class="overflow-auto rounded-2xl shadow bg-white"></div>
    <div class="flex items-center justify-between mt-3">
      <div id="countInfo" class="text-sm text-gray-600"></div>
      <div class="flex items-center gap-2">
        <button id="prevBtn" class="px-3 py-1 rounded-lg border">Trước</button>
        <span id="pageInfo" class="text-sm"></span>
        <button id="nextBtn" class="px-3 py-1 rounded-lg border">Sau</button>
        <label class="ml-4 text-sm">/ Trang
          <select id="pageSize" class="ml-1 border rounded-lg px-2 py-1">
            <option>10</option>
            <option selected>25</option>
            <option>50</option>
            <option>100</option>
          </select>
        </label>
      </div>
    </div>
  </div>
  <script>
    const csvUrlInput = document.getElementById('csvUrl');
    const loadBtn = document.getElementById('loadBtn');
    const searchInput = document.getElementById('searchInput');
    const tableWrap = document.getElementById('tableWrap');
    const countInfo = document.getElementById('countInfo');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const pageInfo = document.getElementById('pageInfo');
    const pageSizeSelect = document.getElementById('pageSize');
    const columnToggles = document.getElementById('columnToggles');

    let columns = [], rows = [], filtered = [];
    let page = 1, pageSize = parseInt(pageSizeSelect.value, 10);
    let sortBy = null;

    function parseCSV(str) {
      const rows = [];
      let inQuotes = false, field = '', row = [];
      for (let i = 0; i < str.length; i++) {
        const c = str[i];
        if (inQuotes) {
          if (c === '"' && str[i+1] === '"') { field += '"'; i++; }
          else if (c === '"') inQuotes = false;
          else field += c;
        } else {
          if (c === '"') inQuotes = true;
          else if (c === ',') { row.push(field); field = ''; }
          else if (c === '\n') { row.push(field); rows.push(row); row = []; field = ''; }
          else field += c;
        }
      }
      if (field) row.push(field);
      if (row.length) rows.push(row);
      return rows;
    }

    function loadData() {
      const url = csvUrlInput.value.trim();
      if (!url) { alert('Cần nhập link CSV'); return; }
      tableWrap.innerHTML = '<div class="p-6">Đang tải dữ liệu...</div>';
      fetch(url).then(res => {
        if (!res.ok) throw new Error('Không tải được CSV');
        return res.text();
      }).then(txt => {
        const matrix = parseCSV(txt);
        columns = matrix[0];
        rows = matrix.slice(1).map(r => Object.fromEntries(columns.map((c, i) => [c, r[i] || ''])));
        page = 1; sortBy = null;
        renderAll();
      }).catch(err => {
        console.error(err);
        alert('Lỗi khi tải dữ liệu: ' + err.message);
      });
    }

    function renderAll() {
      const q = searchInput.value.trim().toLowerCase();
      filtered = rows.filter(r => columns.some(c => (r[c] || '').toLowerCase().includes(q)));

      if (sortBy) {
        const { key, dir } = sortBy;
        filtered.sort((a, b) => {
          const va = a[key] || '', vb = b[key] || '';
          const na = parseFloat(va.replace(/[^0-9.\-]/g, ''));
          const nb = parseFloat(vb.replace(/[^0-9.\-]/g, ''));
          let cmp;
          if (!isNaN(na) && !isNaN(nb)) cmp = na - nb;
          else cmp = va.localeCompare(vb);
          return dir === 'asc' ? cmp : -cmp;
        });
      }

      pageSize = parseInt(pageSizeSelect.value, 10) || 10;
      const total = filtered.length;
      const last = Math.max(1, Math.ceil(total / pageSize));
      if (page > last) page = last;

      const start = (page - 1) * pageSize;
      const pageRows = filtered.slice(start, start + pageSize);

      renderTable(pageRows);
      countInfo.textContent = `${total} dòng — Trang ${page} / ${last}`;
      pageInfo.textContent = `${page}/${last}`;
    }

    function renderTable(data) {
      if (!columns.length) {
        tableWrap.innerHTML = '<div class="p-6">Không có dữ liệu để hiển thị.</div>';
        return;
      }
      if (!columnToggles.dataset.inited) {
        columnToggles.dataset.inited = '1';
        columnToggles.innerHTML = columns.map((c, i) => `
          <label class="inline-flex items-center gap-1 px-2 py-1 border rounded-lg">
            <input type="checkbox" class="col-toggle" data-idx="${i}" checked />
            <span class="text-sm">${c}</span>
          </label>`).join('');
        columnToggles.addEventListener('change', renderAll);
      }

      const hidden = new Set([...columnToggles.querySelectorAll('.col-toggle')]
        .filter(cb => !cb.checked).map(cb => parseInt(cb.dataset.idx, 10)));

      let html = '<table class="min-w-full text-sm"><thead><tr>'
        + columns.map((c, i) => hidden.has(i) ? '' : `
          <th data-key="${c}" class="px-3 py-2 border-b cursor-pointer">${c} ⇅</th>`).join('')
        + '</tr></thead><tbody>';
      data.forEach(row => {
        html += '<tr class="hover:bg-indigo-50/40">';
        columns.forEach((c, i) => {
          if (!hidden.has(i)) {
            let v = row[c] || '';
            if (/^0x[0-9a-f]{6,}$/i.test(v)) v = `<code class="text-xs">${v}</code>`;
            else if (/^\d+\.\d+\.\d+\.\d+(:\d+)?$/.test(v)) v = `<span class="font-mono text-xs">${v}</span>`;
            else if (/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(v)) v = `<a class="text-indigo-600 hover:underline" href="mailto:${v}">${v}</a>`;
            else if (/RISK/i.test(v)) v = `<span class="px-2 py-0.5 rounded-full text-xs bg-red-100 text-red-700">${v}</span>`;
            else if (/Pre\s*BAS|ok/i.test(v)) v = `<span class="px-2 py-0.5 rounded-full text-xs bg-green-100 text-green-700">${v}</span>`;
            else if (/chính\s*chủ|owner/i.test(v)) v = `<span class="px-2 py-0.5 rounded-full text-xs bg-slate-100 text-slate-700">${v}</span>`;
            html += `<td class="px-3 py-2 border-b align-top">${v}</td>`;
          }
        });
        html += '</tr>';
      });
      html += '</tbody></table>';
      tableWrap.innerHTML = html;

      tableWrap.querySelectorAll('th[data-key]').forEach(th => {
        th.addEventListener('click', () => {
          const key = th.dataset.key;
          if (!sortBy || sortBy.key !== key) sortBy = { key, dir: 'asc' };
          else sortBy.dir = sortBy.dir === 'asc' ? 'desc' : 'asc';
          renderAll();
        });
      });
    }

    loadBtn.addEventListener('click', loadData);
    searchInput.addEventListener('input', () => { page = 1; renderAll(); });
    prevBtn.addEventListener('click', () => { if (page > 1) { page--; renderAll() } });
    nextBtn.addEventListener('click', () => { const total = filtered.length; const last = Math.max(1, Math.ceil(total / pageSize)); if (page < last) { page++; renderAll() } });
    pageSizeSelect.addEventListener('change', () => { page = 1; renderAll() });

    window.addEventListener('load', loadData);
  </script>
</body>
</html>